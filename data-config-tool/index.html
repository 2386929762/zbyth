<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数据表管理工具</title>
  <script src="./preload.js" devSdkUrl="https://demo.kwaidoo.com/zbyth/process/wp-core/api/getPanelXSdk"></script>
</head>

<body>
  <div id="root"></div>

  <script type="module">
    import { tryLoadGpfLoginToken, isLocalDevelopment } from './src/lib/sdk.js';

    // SDK 配置
    window.SDK_CONFIG = {
      devDefaultBaseUrl: 'https://demo.kwaidoo.com/zbyth/process/',
      busDomainCode: 'OctoCM_BDYTH',
      // 数据源管理 panelCode
      dataSourcePanelCode: 'OctoCM_BDYTH_IML_00005',
      // 表管理 panelCode
      tablePanelCode: 'OctoCM_BDYTH_IML_00003'
    };

    async function ensureLogin(sdk, loginPayload, parentUrl) {
      if (window.self !== window.top) {  // 在 iframe 中
        try {
          // 尝试获取父窗口 URL
          parentUrl = parentUrl || window.parent.location.href;
        } catch (e) { console.warn("Cannot access parent location", e); }

        console.log('[SDK] 检测到在 iframe 中运行，父窗口 URL:', parentUrl);

        if (parentUrl) {
          // 尝试加载 GPF token
          tryLoadGpfLoginToken(sdk, parentUrl);
        }

        // 检查是否登录成功
        if (!sdk.user.isAuthenticated()) {
          throw new Error("Iframe 环境下用户未登录且无法加载 GPF Token");
        }
        console.log('[SDK] GPF Token 加载成功，跳过默认登录');

      } else {  // 不在 iframe 中
        if (!sdk.user.isAuthenticated()) {
          if (isLocalDevelopment(window.location.hostname)) {
            // 执行默认登录
            console.log('[SDK] 用户未登录，开始登录流程');
            await sdk.user.login(loginPayload);
            console.log('[SDK] 登录成功');
          } else {
            throw new Error("用户未登录，无法访问系统");
          }
        } else {
          console.log('[SDK] 用户已登录，跳过登录流程');
        }
      }
    }

    // 等待 PanelXSdk 类加载完成后再初始化
    (async function initSDK() {
      // 检查 PanelXSdk 是否已加载
      if (typeof PanelXSdk !== 'undefined') {
        try {
          // 初始化 SDK
          window.panelxSdk = new PanelXSdk({
            devDefaultBaseUrl: window.SDK_CONFIG.devDefaultBaseUrl,
            busDomainCode: window.SDK_CONFIG.busDomainCode
          });
          console.log('[SDK] PanelX SDK 初始化成功');

          // 执行登录检查
          await ensureLogin(window.panelxSdk, {
            userName: 'admin',
            password: '123456'
          });

          // 所有流程通过，触发事件
          window.sdkLoggedIn = true;
          window.dispatchEvent(new CustomEvent('sdkReady'));
          window.dispatchEvent(new Event('sdkLoggedIn'));

        } catch (error) {
          console.error('[SDK] 初始化或登录失败', error);
          alert('登录失败: ' + (error.message || '未知错误'));
          throw error;
        }
      } else {
        // 如果还未加载，100ms 后重试
        setTimeout(initSDK, 100);
      }
    })();
  </script>

  <script type="module" src="/src/main.jsx"></script>
</body>

</html>