<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数据表管理工具</title>
  <script src="./preload.js" devSdkUrl="https://demo.kwaidoo.com/zbyth/process/wp-core/api/getPanelXSdk"></script>
</head>

<body>
  <div id="root"></div>

  <script>
    // SDK 配置
    window.SDK_CONFIG = {
      devDefaultBaseUrl: 'https://demo.kwaidoo.com/zbyth/process/',
      busDomainCode: 'OctoCM_BDYTH',
      // 数据源管理 panelCode
      dataSourcePanelCode: 'OctoCM_BDYTH_IML_00005',
      // 表管理 panelCode
      tablePanelCode: 'OctoCM_BDYTH_IML_00003'
    };

    // 等待 PanelXSdk 类加载完成后再初始化
    (function initSDK() {
      // 检查 PanelXSdk 是否已加载
      if (typeof PanelXSdk !== 'undefined') {
        // 初始化 SDK
        window.panelxSdk = new PanelXSdk({
          devDefaultBaseUrl: window.SDK_CONFIG.devDefaultBaseUrl,
          busDomainCode: window.SDK_CONFIG.busDomainCode
        });
        console.log('[SDK] PanelX SDK 初始化成功');

        // 触发自定义事件通知 React 应用 SDK 已就绪
        window.dispatchEvent(new CustomEvent('sdkReady'));

        // 检查是否已经登录
        if (window.panelxSdk.user.isAuthenticated()) {
          console.log('[SDK] 用户已登录，跳过登录流程');
          window.sdkLoggedIn = true;
          window.dispatchEvent(new Event('sdkLoggedIn'));
        } else {
          // 未登录，执行登录
          console.log('[SDK] 用户未登录，开始登录流程');
          window.panelxSdk.user.login({
            userName: 'admin',
            password: '123456'
          }).then(function (res) {
            console.log('[SDK] 登录成功', res);
            window.sdkLoggedIn = true;
            window.dispatchEvent(new Event('sdkLoggedIn'));
          }).catch(function (error) {
            console.error('[SDK] 登录失败', error);
            alert('登录失败: ' + error.message);
          });
        }
      } else {
        // 如果还未加载，100ms 后重试
        setTimeout(initSDK, 100);
      }
    })();
  </script>

  <script type="module" src="/src/main.jsx"></script>
</body>

</html>