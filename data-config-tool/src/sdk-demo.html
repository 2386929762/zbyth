
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SDK Demo</title>
    <style>
      /* åŸºç¡€æ ·å¼é‡ç½® */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
          'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        width: 100%;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
      }

      h1 {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-bottom: 30px;
      }

      .info-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
      }

      .info-item:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }

      .info-value {
        color: #6c757d;
        font-size: 14px;
        font-family: 'Courier New', monospace;
      }

      .status-section {
        margin-bottom: 30px;
      }

      .status-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .status-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .status-icon.pending {
        background: #ffc107;
      }

      .status-icon.success {
        background: #28a745;
      }

      .status-icon.error {
        background: #dc3545;
      }

      .status-text {
        flex: 1;
        font-size: 14px;
        color: #495057;
      }

      .status-time {
        font-size: 12px;
        color: #6c757d;
        font-family: 'Courier New', monospace;
      }

      .log-section {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
      }

      .log-entry {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        margin-bottom: 8px;
        color: #d4d4d4;
      }

      .log-entry.info {
        color: #4fc3f7;
      }

      .log-entry.success {
        color: #66bb6a;
      }

      .log-entry.error {
        color: #ef5350;
      }

      .log-timestamp {
        color: #888;
        margin-right: 8px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      .log-section::-webkit-scrollbar {
        width: 8px;
      }

      .log-section::-webkit-scrollbar-track {
        background: #2d2d2d;
        border-radius: 4px;
      }

      .log-section::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
      }

      .log-section::-webkit-scrollbar-thumb:hover {
        background: #666;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background: #d4edda;
        color: #155724;
      }

      .badge-warning {
        background: #fff3cd;
        color: #856404;
      }

      .badge-danger {
        background: #f8d7da;
        color: #721c24;
      }

      /* Banner æ ·å¼ */
      .banner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .banner h1 {
        margin: 0;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        padding: 10px 16px;
        border-radius: 8px;
      }

      .user-label {
        font-size: 14px;
        color: #6c757d;
      }

      .user-name {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
      }

      /* æ“ä½œæŒ‰é’®æ  */
      .actions-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      /* æœç´¢æ  */
      .search-bar {
        margin-bottom: 20px;
      }

      .search-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 14px;
        color: #495057;
        transition: border-color 0.2s;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .search-input::placeholder {
        color: #adb5bd;
      }

      .action-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background: #667eea;
        color: white;
      }

      .action-btn:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* è¡¨æ ¼æ ·å¼ */
      .table-container {
        margin-bottom: 30px;
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .data-table thead {
        background: #f8f9fa;
      }

      .data-table th {
        padding: 12px 16px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
      }

      .data-table td {
        padding: 12px 16px;
        font-size: 14px;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
      }

      .data-table tbody tr:hover {
        background: #f8f9fa;
      }

      .data-table tbody tr:last-child td {
        border-bottom: none;
      }

      .loading-cell {
        text-align: center;
        color: #6c757d;
        font-style: italic;
      }

      .empty-cell {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px;
      }

      .data-table tbody tr {
        cursor: pointer;
      }

      /* å¼¹çª—æ ·å¼ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: #f8f9fa;
        color: #333;
      }

      .modal-body {
        padding: 24px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        color: #495057;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-input:disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: #667eea;
        color: white;
      }

      .modal-btn-primary:hover:not(:disabled) {
        background: #5568d3;
      }

      .modal-btn-secondary {
        background: #6c757d;
        color: white;
      }

      .modal-btn-secondary:hover {
        background: #5a6268;
      }

      .modal-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      /* åˆ†é¡µæ  */
      .pagination-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        margin-top: 20px;
      }

      .pagination-info,
      .pagination-size {
        font-size: 14px;
        color: #6c757d;
      }

      .pagination-info span span,
      .pagination-size span span {
        font-weight: 600;
        color: #495057;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .pagination-btn {
        padding: 8px 16px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        background: white;
        color: #495057;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .pagination-btn:hover:not(:disabled) {
        background: #f8f9fa;
        border-color: #667eea;
        color: #667eea;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-text {
        font-size: 14px;
        color: #495057;
      }

      .pagination-text span {
        font-weight: 600;
        color: #667eea;
      }

      .page-size-select {
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        color: #495057;
        cursor: pointer;
        margin: 0 8px;
        transition: border-color 0.2s;
      }

      .page-size-select:focus {
        outline: none;
        border-color: #667eea;
      }

      /* Checkbox åˆ— */
      .checkbox-col {
        width: 50px;
        text-align: center;
      }

      .table-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="banner">
        <h1>SDK Demo</h1>
        <div class="user-info">
          <span class="user-label">å½“å‰ç”¨æˆ·ï¼š</span>
          <span class="user-name" id="userName">åŠ è½½ä¸­...</span>
        </div>
      </div>

      <div class="actions-bar" id="actionsBar">
        <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
      </div>

      <div class="search-bar">
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="è¾“å…¥å…³é”®è¯æœç´¢ï¼ŒæŒ‰å›è½¦æŸ¥è¯¢..."
        />
      </div>

      <div class="table-container">
        <table class="data-table" id="dataTable">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" id="selectAll" class="table-checkbox" />
              </th>
              <th>è¾“å…¥1</th>
              <th>è¾“å…¥2</th>
              <th>æµ‹è¯•æµç¨‹çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="4" class="loading-cell">åŠ è½½ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-bar" id="paginationBar">
        <div class="pagination-info">
          <span>å…± <span id="totalCount">0</span> æ¡</span>
        </div>
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn" disabled>ä¸Šä¸€é¡µ</button>
          <span class="pagination-text"
            >ç¬¬ <span id="currentPage">1</span> / <span id="totalPages">1</span> é¡µ</span
          >
          <button class="pagination-btn" id="nextBtn" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
        <div class="pagination-size">
          <span>æ¯é¡µ</span>
          <select class="page-size-select" id="pageSizeSelect">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span>æ¡</span>
        </div>
      </div>
    </div>

    <!-- è¡¨å•å¼¹çª— -->
    <div class="modal-overlay" id="formModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">è¡¨å•è¯¦æƒ…</div>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
          <div class="loading-spinner">åŠ è½½ä¸­...</div>
        </div>
        <div class="modal-footer" id="modalFooter">
          <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
        </div>
      </div>
    </div>

    <script>
      // æ ¹æ®ç¯å¢ƒåŠ¨æ€åŠ è½½ SDK
      const isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const sdkUrl = isDev ? '../panelx-sdk.js' : '/wp-core/api/getPanelXSdk';
      const script = document.createElement('script');
      script.src = sdkUrl;
      document.head.appendChild(script);
    </script>
    <script>
      // é…ç½®ä¿¡æ¯
      const CONFIG = {
        devDefaultBaseUrl: 'http://183.6.70.7:24689',
        busDomainCode: 'SdkTest',
        username: 'admin',
        password: '123456',
        panelCode: 'SdkTest_IML_00002',
        pageSize: 5, // æ¯é¡µæ˜¾ç¤ºæ¡æ•°
      }

      // SDK å®ä¾‹
      let sdk = null

      // å½“å‰è¡¨å•æ•°æ®ï¼ˆç”¨äºæ–°å¢å’Œç¼–è¾‘è¡¨å•ï¼‰
      let currentForm = null

      // å½“å‰è¡¨æ ¼æ•°æ®åˆ—è¡¨
      let currentTableData = []

      // åˆ†é¡µçŠ¶æ€
      let currentPageNo = 1
      let totalRecords = 0
      let currentKeyword = ''

      // DOM å…ƒç´ 
      const userName = document.getElementById('userName')
      const actionsBar = document.getElementById('actionsBar')
      const searchInput = document.getElementById('searchInput')
      const tableBody = document.getElementById('tableBody')
      const formModal = document.getElementById('formModal')
      const modalTitle = document.getElementById('modalTitle')
      const modalBody = document.getElementById('modalBody')
      const modalFooter = document.getElementById('modalFooter')
      const closeModal = document.getElementById('closeModal')

      // åˆ†é¡µå…ƒç´ 
      const totalCount = document.getElementById('totalCount')
      const currentPage = document.getElementById('currentPage')
      const totalPages = document.getElementById('totalPages')
      const pageSizeSelect = document.getElementById('pageSizeSelect')
      const prevBtn = document.getElementById('prevBtn')
      const nextBtn = document.getElementById('nextBtn')

      // Checkbox å…ƒç´ 
      const selectAllCheckbox = document.getElementById('selectAll')

      /**
       * æ·»åŠ æ—¥å¿—ï¼ˆæ§åˆ¶å°è¾“å‡ºï¼‰
       */
      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false })
        console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`)
      }

      /**
       * æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
       */
      function displayUserInfo() {
        try {
          const userInfo = sdk.user.getUserInfo()
          if (userInfo && userInfo.fullName) {
            userName.textContent = userInfo.fullName
            addLog(`ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ: ${userInfo.fullName}`, 'success')
          } else {
            userName.textContent = 'æœªçŸ¥ç”¨æˆ·'
            addLog('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´', 'error')
          }
        } catch (error) {
          userName.textContent = 'è·å–å¤±è´¥'
          addLog(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error')
        }
      }

      /**
       * åŠ è½½æƒé™çŸ©é˜µå¹¶æ˜¾ç¤ºæŒ‰é’®
       */
      async function loadPermissions() {
        try {
          addLog('å¼€å§‹åŠ è½½æƒé™çŸ©é˜µ...', 'info')
          const result = await sdk.api.getPermMatrix({ panelCode: CONFIG.panelCode })

          if (
            result &&
            result.data &&
            result.data.privilege &&
            result.data.privilege.actionPrivileges
          ) {
            const actions = result.data.privilege.actionPrivileges
            addLog(`æƒé™åŠ è½½æˆåŠŸï¼Œå…± ${actions.length} ä¸ªæ“ä½œ`, 'success')

            // æ¸…ç©ºæŒ‰é’®æ 
            actionsBar.innerHTML = ''

            // æ¸²æŸ“æŒ‰é’®
            actions.forEach((action) => {
              if (action.visible) {
                const btn = document.createElement('button')
                btn.className = 'action-btn'
                btn.textContent = action.name
                btn.disabled = !action.operatable
                btn.onclick = () => handleActionClick(action.name)
                actionsBar.appendChild(btn)
              }
            })
          } else {
            addLog('æƒé™æ•°æ®æ ¼å¼é”™è¯¯', 'error')
          }
        } catch (error) {
          addLog(`åŠ è½½æƒé™å¤±è´¥: ${error.message}`, 'error')
        }
      }

      /**
       * å¤„ç†æŒ‰é’®ç‚¹å‡»
       */
      async function handleActionClick(actionName) {
        addLog(`ç‚¹å‡»æ“ä½œ: ${actionName}`, 'info')

        // å¦‚æœæ˜¯æ–°å¢æµç¨‹ï¼Œæ‰“å¼€æ–°å»ºè¡¨å•
        if (actionName === 'æ–°å¢æµç¨‹') {
          openNewFormModal(actionName)
          return
        }

        // æ”¶é›†é€‰ä¸­è¡Œçš„ç¼–å·
        const selectedRows = []
        const checkboxes = document.querySelectorAll('.row-checkbox:checked')

        checkboxes.forEach((checkbox) => {
          const index = parseInt(checkbox.getAttribute('data-index'))
          const rowData = currentTableData[index]
          if (rowData && rowData['ç¼–å·']) {
            selectedRows.push(rowData['ç¼–å·'])
          }
        })

        addLog(`é€‰ä¸­çš„è¡Œç¼–å·: ${JSON.stringify(selectedRows)}`, 'info')

        try {
          // æ„é€ è¯·æ±‚å‚æ•°
          const payload = {
            panelCode: CONFIG.panelCode,
            buttonName: actionName,
          }

          // åªæœ‰é€‰ä¸­è¡Œæ—¶æ‰æ·»åŠ  buttonParam
          if (selectedRows.length > 0) {
            payload.buttonParam = {
              rowCodes: selectedRows,
            }
          }

          // è°ƒç”¨æŒ‰é’®æ“ä½œ
          const result = await sdk.api.callButton(payload)

          addLog(`æ“ä½œæˆåŠŸ: ${JSON.stringify(result)}`, 'info')

          // åˆ·æ–°è¡¨æ ¼æ•°æ®
          loadTableData(currentPageNo, currentKeyword)
        } catch (error) {
          addLog(`æ“ä½œå¤±è´¥: ${error.message}`, 'error')
          alert(`æ“ä½œå¤±è´¥: ${error.message}`)
        }
      }

      /**
       * æ‰“å¼€è¡¨å•å¼¹çª—çš„é€šç”¨å‡½æ•°
       * @param {Function} apiCall - API è°ƒç”¨å‡½æ•°ï¼Œè¿”å› Promise
       * @param {string} logPrefix - æ—¥å¿—å‰ç¼€
       */
      async function openModal(apiCall, logPrefix) {
        try {
          // æ˜¾ç¤ºå¼¹çª—
          formModal.classList.add('active')
          modalBody.innerHTML = '<div class="loading-spinner">åŠ è½½ä¸­...</div>'
          modalFooter.innerHTML = ''

          // è°ƒç”¨ API
          const result = await apiCall()

          if (result && result.data) {
            // ä¿å­˜å½“å‰è¡¨å•æ•°æ®
            currentForm = result.data.data || {}
            addLog(`${logPrefix}æ•°æ®: ${JSON.stringify(currentForm)}`, 'info')

            renderForm(result.data)
          } else {
            modalBody.innerHTML = '<div class="loading-spinner">æ•°æ®æ ¼å¼é”™è¯¯</div>'
          }
        } catch (error) {
          addLog(`${logPrefix}å¤±è´¥: ${error.message}`, 'error')
          modalBody.innerHTML = `<div class="loading-spinner">åŠ è½½å¤±è´¥: ${error.message}</div>`
        }
      }

      /**
       * æ‰“å¼€æ–°å»ºè¡¨å•å¼¹çª—
       */
      async function openNewFormModal(operationName) {
        await openModal(
          () =>
            sdk.api.getNewFormPermMatrix({
              panelCode: CONFIG.panelCode,
              operationName: operationName,
            }),
          'ä¿å­˜æ–°å»ºè¡¨å•'
        )
      }

      /**
       * æ‰“å¼€è¡¨å•å¼¹çª—
       */
      async function openFormModal(rowData) {
        const formCode = rowData['ç¼–å·']
        addLog(`æ‰“å¼€è¡¨å•ï¼Œç¼–å·: ${formCode}`, 'info')

        await openModal(
          () =>
            sdk.api.getFormDescriptor({
              panelCode: CONFIG.panelCode,
              code: formCode,
            }),
          'ä¿å­˜ç¼–è¾‘è¡¨å•'
        )
      }

      /**
       * æ¸²æŸ“è¡¨å•ï¼ˆé€šç”¨å‡½æ•°ï¼Œç”¨äºæ–°å¢å’Œç¼–è¾‘ï¼‰
       */
      function renderForm(formData) {
        const { data, meta, privilege } = formData

        // åˆ›å»ºå­—æ®µæƒé™æ˜ å°„
        const fieldPrivilegeMap = {}
        if (privilege && privilege.fieldPrivileges) {
          privilege.fieldPrivileges.forEach((fp) => {
            fieldPrivilegeMap[fp.fieldName] = fp
          })
        }

        // æ¸²æŸ“è¡¨å•å­—æ®µ
        let formHtml = ''
        if (meta && meta.length > 0) {
          meta.forEach((field) => {
            const fieldPrivilege = fieldPrivilegeMap[field.name]

            // å¦‚æœæœ‰å­—æ®µæƒé™é…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦å¯è§ï¼›å¦‚æœæ²¡æœ‰é…ç½®ï¼Œé»˜è®¤å¯è§
            if (fieldPrivilege && !fieldPrivilege.visible) {
              return // è·³è¿‡ä¸å¯è§å­—æ®µ
            }

            // ä» data ä¸­è·å–å­—æ®µå€¼
            const value = (data && data[field.name]) || ''
            // å¦‚æœæœ‰å­—æ®µæƒé™é…ç½®ï¼Œæ ¹æ® writable å†³å®šï¼›å¦‚æœæ²¡æœ‰é…ç½®ï¼Œé»˜è®¤å¯ç¼–è¾‘
            const isReadonly = fieldPrivilege ? !fieldPrivilege.writable : false

            formHtml += `
                        <div class="form-group">
                            <label class="form-label">${field.name}</label>
                            <input 
                                type="text" 
                                class="form-input" 
                                value="${value}" 
                                data-field="${field.name}"
                                ${isReadonly ? 'disabled' : ''}
                            />
                        </div>
                    `
          })
        }

        modalBody.innerHTML = formHtml || '<div class="loading-spinner">æ— å¯æ˜¾ç¤ºå­—æ®µ</div>'

        // æ¸²æŸ“æ“ä½œæŒ‰é’®
        renderModalButtons(privilege)
      }

      /**
       * æ¸²æŸ“å¼¹çª—æŒ‰é’®
       */
      function renderModalButtons(privilege) {
        modalFooter.innerHTML = ''

        // å®šä¹‰éœ€è¦æ˜¾ç¤ºçš„æŒ‰é’®ï¼ˆé™¤äº†å–æ¶ˆï¼‰
        const buttonOrder = ['æäº¤', 'é€šè¿‡', 'ä¸é€šè¿‡']

        // åˆ›å»ºæƒé™æ˜ å°„
        const actionMap = {}
        if (privilege && privilege.actionPrivileges) {
          privilege.actionPrivileges.forEach((action) => {
            actionMap[action.name] = action
          })
        }

        // å–æ¶ˆæŒ‰é’®å§‹ç»ˆæ˜¾ç¤ºä¸”å¯ç”¨
        const cancelBtn = document.createElement('button')
        cancelBtn.className = 'modal-btn modal-btn-secondary'
        cancelBtn.textContent = 'å–æ¶ˆ'
        cancelBtn.onclick = closeFormModal
        modalFooter.appendChild(cancelBtn)

        // æŒ‰é¡ºåºæ¸²æŸ“é¢„å®šä¹‰çš„æŒ‰é’®ï¼Œé€šè¿‡æƒé™è¿‡æ»¤
        buttonOrder.forEach((buttonName) => {
          const action = actionMap[buttonName]
          if (action && action.visible) {
            const btn = document.createElement('button')
            btn.className = 'modal-btn modal-btn-primary'
            btn.textContent = action.name
            btn.disabled = !action.operatable
            btn.onclick = () => handleFormAction(action.name)
            modalFooter.appendChild(btn)
          }
        })
      }

      /**
       * å¤„ç†è¡¨å•æ“ä½œ
       */
      async function handleFormAction(actionName) {
        try {
          addLog(`è¡¨å•æ“ä½œ: ${actionName}`, 'info')

          // æ”¶é›†è¡¨å•æ•°æ®
          const formData = collectFormData()
          addLog(`æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®: ${JSON.stringify(formData)}`, 'info')

          // è°ƒç”¨ SDK çš„ callButton æ–¹æ³•ï¼ˆæ–°ç‰ˆï¼‰
          const result = await sdk.api.callButton({
            panelCode: CONFIG.panelCode,
            buttonName: actionName,
            formData: formData,
          })

          addLog(`æŒ‰é’®è°ƒç”¨æˆåŠŸ: ${actionName}`, 'success')
          addLog(`è¿”å›ç»“æœ: ${JSON.stringify(result)}`, 'info')

          // å…³é—­å¼¹çª—å¹¶åˆ·æ–°è¡¨æ ¼æ•°æ®
          closeFormModal()
          await loadTableData()
        } catch (error) {
          addLog(`æŒ‰é’®è°ƒç”¨å¤±è´¥: ${error.message}`, 'error')
          alert(`æ“ä½œå¤±è´¥: ${error.message}`)
        }
      }

      /**
       * æ”¶é›†è¡¨å•æ•°æ®
       */
      function collectFormData() {
        // ä» currentForm å¤åˆ¶æ‰€æœ‰æ•°æ®ä½œä¸ºåŸºç¡€
        const formData = currentForm ? { ...currentForm } : {}

        // è·å–è¡¨å•è¾“å…¥å¹¶è¦†ç›–åˆ° formData
        const inputs = modalBody.querySelectorAll('.form-input')
        inputs.forEach((input) => {
          const fieldName = input.getAttribute('data-field')
          const value = input.value
          if (fieldName) {
            formData[fieldName] = value
          }
        })

        addLog(`æ„é€ çš„è¡¨å•æ•°æ®: ${JSON.stringify(formData)}`, 'info')
        return formData
      }

      /**
       * å…³é—­è¡¨å•å¼¹çª—
       */
      function closeFormModal() {
        formModal.classList.remove('active')
      }

      /**
       * åŠ è½½è¡¨æ ¼æ•°æ®
       */
      async function loadTableData(pageNo = 1, keyword = '') {
        try {
          currentPageNo = pageNo
          currentKeyword = keyword

          const logMsg = keyword ? `æœç´¢: ${keyword}, ç¬¬ ${pageNo} é¡µ` : `åŠ è½½ç¬¬ ${pageNo} é¡µæ•°æ®`
          addLog(logMsg, 'info')
          tableBody.innerHTML = '<tr><td colspan="3" class="loading-cell">åŠ è½½ä¸­...</td></tr>'

          // æ„å»ºæŸ¥è¯¢å‚æ•°
          const queryParams = {
            panelCode: CONFIG.panelCode,
            pageNo: pageNo,
            pageSize: CONFIG.pageSize,
          }

          // å¦‚æœæœ‰å…³é”®è¯ï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
          if (keyword) {
            queryParams.keyword = keyword
          }

          const result = await sdk.api.queryFormDataList(queryParams)

          if (result && result.data) {
            const dataList = result.data.list || []
            totalRecords = result.data.totalSize || 0

            addLog(`æ•°æ®åŠ è½½æˆåŠŸï¼Œå…± ${totalRecords} æ¡è®°å½•`, 'success')

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePagination()

            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = ''

            // ä¿å­˜å½“å‰è¡¨æ ¼æ•°æ®
            currentTableData = dataList

            if (dataList.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="4" class="empty-cell">æš‚æ— æ•°æ®</td></tr>'
            } else {
              // æ¸²æŸ“æ•°æ®
              dataList.forEach((item, index) => {
                const row = document.createElement('tr')
                row.innerHTML = `
                                <td class="checkbox-col">
                                    <input type="checkbox" class="table-checkbox row-checkbox" data-index="${index}" />
                                </td>
                                <td>${item['è¾“å…¥1'] || '-'}</td>
                                <td>${item['è¾“å…¥2'] || '-'}</td>
                                <td>${item['æµ‹è¯•æµç¨‹çŠ¶æ€'] || '-'}</td>
                            `
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæ’é™¤ checkboxï¼‰
                row.onclick = (e) => {
                  if (!e.target.classList.contains('row-checkbox')) {
                    openFormModal(item)
                  }
                }
                tableBody.appendChild(row)
              })

              // é‡ç½®å…¨é€‰çŠ¶æ€
              selectAllCheckbox.checked = false
            }
          } else {
            tableBody.innerHTML = '<tr><td colspan="4" class="empty-cell">æ•°æ®æ ¼å¼é”™è¯¯</td></tr>'
            addLog('æ•°æ®æ ¼å¼é”™è¯¯', 'error')
          }
        } catch (error) {
          tableBody.innerHTML = '<tr><td colspan="4" class="empty-cell">åŠ è½½å¤±è´¥</td></tr>'
          addLog(`åŠ è½½è¡¨æ ¼æ•°æ®å¤±è´¥: ${error.message}`, 'error')
        }
      }

      /**
       * æ›´æ–°åˆ†é¡µä¿¡æ¯
       */
      function updatePagination() {
        const totalPage = Math.ceil(totalRecords / CONFIG.pageSize) || 1

        totalCount.textContent = totalRecords
        currentPage.textContent = currentPageNo
        totalPages.textContent = totalPage

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        prevBtn.disabled = currentPageNo <= 1
        nextBtn.disabled = currentPageNo >= totalPage
      }

      /**
       * ä¸Šä¸€é¡µ
       */
      function goToPrevPage() {
        if (currentPageNo > 1) {
          loadTableData(currentPageNo - 1, currentKeyword)
        }
      }

      /**
       * ä¸‹ä¸€é¡µ
       */
      function goToNextPage() {
        const totalPage = Math.ceil(totalRecords / CONFIG.pageSize)
        if (currentPageNo < totalPage) {
          loadTableData(currentPageNo + 1, currentKeyword)
        }
      }

      /**
       * æ‰§è¡Œæœç´¢
       */
      function performSearch() {
        const keyword = searchInput.value.trim()
        loadTableData(1, keyword) // æœç´¢æ—¶é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      }

      /**
       * åˆ‡æ¢å…¨é€‰çŠ¶æ€
       */
      function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.row-checkbox')
        checkboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked
        })
      }

      /**
       * æ”¹å˜æ¯é¡µæ¡æ•°
       */
      function changePageSize() {
        CONFIG.pageSize = parseInt(pageSizeSelect.value)
        addLog(`æ¯é¡µæ¡æ•°æ”¹ä¸º: ${CONFIG.pageSize}`, 'info')
        // é‡æ–°åŠ è½½ç¬¬ä¸€é¡µ
        loadTableData(1, currentKeyword)
      }

      /**
       * åˆå§‹åŒ– SDK
       */
      async function initializeSDK() {
        try {
          addLog('å¼€å§‹åˆå§‹åŒ– SDK...', 'info')

          // åˆ›å»º SDK å®ä¾‹
          sdk = new PanelXSdk({
            devDefaultBaseUrl: CONFIG.devDefaultBaseUrl,
            busDomainCode: CONFIG.busDomainCode,
          })

          addLog(`SDK åˆå§‹åŒ–æˆåŠŸ`, 'success')
          addLog(`å¼€å‘ç¯å¢ƒ Base URL: ${CONFIG.devDefaultBaseUrl}`, 'info')
          addLog(`ä¸šåŠ¡åŸŸä»£ç : ${CONFIG.busDomainCode}`, 'info')
          return true
        } catch (error) {
          addLog(`SDK åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error')
          return false
        }
      }

      /**
       * æ‰§è¡Œç™»å½•
       */
      async function performLogin() {
        try {
          addLog('å¼€å§‹ç™»å½•...', 'info')

          const result = await sdk.user.login({
            userName: CONFIG.username,
            password: CONFIG.password,
          })

          addLog('ç™»å½•æˆåŠŸ! ğŸ‰', 'success')
          return true
        } catch (error) {
          addLog(`ç™»å½•å¤±è´¥: ${error.message}`, 'error')
          return false
        }
      }

      /**
       * åŠ è½½æ‰€æœ‰æ•°æ®
       */
      async function loadAllData() {
        addLog('=== å¼€å§‹åŠ è½½æ•°æ® ===', 'info')

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        displayUserInfo()

        // åŠ è½½æƒé™çŸ©é˜µ
        await loadPermissions()

        // åŠ è½½è¡¨æ ¼æ•°æ®
        await loadTableData()

        addLog('=== æ•°æ®åŠ è½½å®Œæˆ ===', 'info')
      }

      /**
       * ä¸»æµç¨‹
       */
      async function main() {
        addLog('=== SDK Demo å¯åŠ¨ ===', 'info')

        // åˆå§‹åŒ– SDK
        const initSuccess = await initializeSDK()
        if (!initSuccess) {
          return
        }

        // æ‰§è¡Œç™»å½•
        const loginSuccess = await performLogin()
        if (!loginSuccess) {
          return
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        await loadAllData()
      }

      // å…³é—­å¼¹çª—äº‹ä»¶
      closeModal.addEventListener('click', closeFormModal)

      // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
      formModal.addEventListener('click', (e) => {
        if (e.target === formModal) {
          closeFormModal()
        }
      })

      // æœç´¢æ¡†å›è½¦äº‹ä»¶
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          performSearch()
        }
      })

      // åˆ†é¡µæŒ‰é’®äº‹ä»¶
      prevBtn.addEventListener('click', goToPrevPage)
      nextBtn.addEventListener('click', goToNextPage)

      // å…¨é€‰äº‹ä»¶
      selectAllCheckbox.addEventListener('change', toggleSelectAll)

      // æ¯é¡µæ¡æ•°å˜æ›´äº‹ä»¶
      pageSizeSelect.addEventListener('change', changePageSize)

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
      window.addEventListener('load', main)
    </script>
  </body>
</html>
